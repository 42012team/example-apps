instances = 2

Vagrant.configure(2) do |config|
    instances.times do |i|
        instance_name = "coreos-#{i}"
        config.vm.define instance_name do |instance|
            instance.vm.box = "yungsang/coreos"

            instance.vm.provider "virtualbox" do |v|
                v.name = instance_name
                v.memory = 630
            end

            instance.vm.network "forwarded_port", guest: 5000, host: 5000 + i

            instance.vm.synced_folder "docker-app", "/docker-app"

            instance.vm.provision "docker" do |d|
                d.build_image "/docker-app", args: "-t 'example-app'"
            end

            instance.vm.provision "shell", inline: "chown core /etc/systemd/system/"
            instance.vm.provision "file", source: "services/example-app.service", destination: "/etc/systemd/system/example-app.service"
            instance.vm.provision "shell", inline: "systemctl start example-app.service"
        end
    end
end
